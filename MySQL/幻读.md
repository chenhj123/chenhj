创建表和记录

```sql
CREATE TABLE `tphantom` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
) ENGINE=InnoDB;

insert into tphantom values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```

### 加锁5个小点

1. 加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。
2. 查找过程中访问到的对象才会加锁。
3. 索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。
4. 索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。
5. 唯一索引上的范围查询会访问到不满足条件的第一个值为止。

### 等值查询间隙锁

|               session A               |                 session B                 |               session C                |
| :-----------------------------------: | :---------------------------------------: | :------------------------------------: |
|                begin;                 |                                           |                                        |
| update tphantom set d=d+1 where id=7; |                                           |                                        |
|                                       | insert into tphantom values(8,8,8);(锁住) |                                        |
|                                       |                                           | update tphantom set d=d+1 where id=10; |

由于表 t 中没有 id=7 的记录，所以用我们上面提到的加锁规则判断一下的话：

1. 根据1，加锁单位为 next-key lock，session A 加锁范围就是(5,10]；
2. 同时根据 2，这是一个等值查询 (id=7)，而 id=10 不满足查询条件，next-key lock 退化成间隙锁，因此最终加锁的范围是 (5,10)。

所以，session B 要往这个间隙里面插入 id=8 的记录会被锁住，但是 session C 修改 id=10 这行是可以的。